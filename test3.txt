# ============================================================================
# VISUALIZATION: PREFIXSPAN JOURNEY PATTERNS
# ============================================================================

import matplotlib.pyplot as plt
import matplotlib.patches as mpatches

# ----------------------------------------------------------------------------
# VIZ 1: Top Successful vs Failed Journeys (Side by Side)
# ----------------------------------------------------------------------------

fig, axes = plt.subplots(1, 2, figsize=(18, 10))

# Successful Journeys
ax1 = axes[0]
ax1.set_title('TOP 10 SUCCESSFUL JOURNEYS', fontsize=14, fontweight='bold', color='green')
ax1.axis('off')

y = 0.95
for i, p in enumerate(pos_patterns[:10], 1):
    ax1.text(0.02, y, f"{i}.", fontsize=11, fontweight='bold', transform=ax1.transAxes, va='top')
    ax1.text(0.06, y, f"{p['users']} users | {p['avg_time']} min | {p['length']} steps", 
             fontsize=9, transform=ax1.transAxes, va='top', color='gray')
    ax1.text(0.02, y - 0.03, p['pattern'][:80], fontsize=8, transform=ax1.transAxes, 
             va='top', family='monospace', color='darkgreen')
    y -= 0.09

# Failed Journeys
ax2 = axes[1]
ax2.set_title('TOP 10 FAILED JOURNEYS', fontsize=14, fontweight='bold', color='red')
ax2.axis('off')

y = 0.95
for i, p in enumerate(neg_patterns[:10], 1):
    ax2.text(0.02, y, f"{i}.", fontsize=11, fontweight='bold', transform=ax2.transAxes, va='top')
    ax2.text(0.06, y, f"{p['users']} users | {p['avg_time']} min | {p['length']} steps", 
             fontsize=9, transform=ax2.transAxes, va='top', color='gray')
    ax2.text(0.02, y - 0.03, p['pattern'][:80], fontsize=8, transform=ax2.transAxes, 
             va='top', family='monospace', color='darkred')
    y -= 0.09

plt.tight_layout()
plt.savefig(f'{DATA_DIR}journey_patterns_{MODEL_NAME}.png', dpi=150, bbox_inches='tight')
plt.show()
print(f"✓ Saved: journey_patterns_{MODEL_NAME}.png")

# ----------------------------------------------------------------------------
# VIZ 2: Pattern Length vs Time (Scatter)
# ----------------------------------------------------------------------------

fig, ax = plt.subplots(figsize=(12, 8))

# Positive patterns
if pos_patterns:
    pos_lens = [p['length'] for p in pos_patterns[:50]]
    pos_times = [p['avg_time'] for p in pos_patterns[:50]]
    pos_users = [p['users'] for p in pos_patterns[:50]]
    ax.scatter(pos_lens, pos_times, s=[u/2 for u in pos_users], alpha=0.6, 
               c='green', label='Successful', edgecolors='darkgreen')

# Negative patterns
if neg_patterns:
    neg_lens = [p['length'] for p in neg_patterns[:50]]
    neg_times = [p['avg_time'] for p in neg_patterns[:50]]
    neg_users = [p['users'] for p in neg_patterns[:50]]
    ax.scatter(neg_lens, neg_times, s=[u/2 for u in neg_users], alpha=0.6, 
               c='red', label='Failed', edgecolors='darkred')

ax.set_xlabel('Journey Length (steps)', fontsize=12)
ax.set_ylabel('Average Time (minutes)', fontsize=12)
ax.set_title('Journey Patterns: Length vs Time\n(Bubble size = # users)', fontsize=14)
ax.legend()
ax.grid(True, alpha=0.3)

plt.tight_layout()
plt.savefig(f'{DATA_DIR}pattern_scatter_{MODEL_NAME}.png', dpi=150, bbox_inches='tight')
plt.show()
print(f"✓ Saved: pattern_scatter_{MODEL_NAME}.png")

# ----------------------------------------------------------------------------
# VIZ 3: Pattern Metrics Comparison (Bar Chart)
# ----------------------------------------------------------------------------

fig, axes = plt.subplots(1, 3, figsize=(15, 5))

# 3a. Avg Time Comparison
ax1 = axes[0]
labels = ['Successful', 'Failed']
avg_times = [
    np.mean([p['avg_time'] for p in pos_patterns[:20]]) if pos_patterns else 0,
    np.mean([p['avg_time'] for p in neg_patterns[:20]]) if neg_patterns else 0
]
bars = ax1.bar(labels, avg_times, color=['green', 'red'])
ax1.set_ylabel('Avg Journey Time (min)')
ax1.set_title('Average Journey Time')
for bar, val in zip(bars, avg_times):
    ax1.text(bar.get_x() + bar.get_width()/2, bar.get_height() + 0.2, 
             f'{val:.1f}', ha='center', fontsize=11)

# 3b. Avg Length Comparison
ax2 = axes[1]
avg_lens = [
    np.mean([p['length'] for p in pos_patterns[:20]]) if pos_patterns else 0,
    np.mean([p['length'] for p in neg_patterns[:20]]) if neg_patterns else 0
]
bars = ax2.bar(labels, avg_lens, color=['green', 'red'])
ax2.set_ylabel('Avg Journey Length (steps)')
ax2.set_title('Average Journey Length')
for bar, val in zip(bars, avg_lens):
    ax2.text(bar.get_x() + bar.get_width()/2, bar.get_height() + 0.2, 
             f'{val:.1f}', ha='center', fontsize=11)

# 3c. Time per Step
ax3 = axes[2]
time_per_step = [
    np.mean([p['time_per_step'] for p in pos_patterns[:20]]) if pos_patterns else 0,
    np.mean([p['time_per_step'] for p in neg_patterns[:20]]) if neg_patterns else 0
]
bars = ax3.bar(labels, time_per_step, color=['green', 'red'])
ax3.set_ylabel('Time per Step (min)')
ax3.set_title('Average Time per Step')
for bar, val in zip(bars, time_per_step):
    ax3.text(bar.get_x() + bar.get_width()/2, bar.get_height() + 0.05, 
             f'{val:.2f}', ha='center', fontsize=11)

plt.tight_layout()
plt.savefig(f'{DATA_DIR}pattern_comparison_{MODEL_NAME}.png', dpi=150, bbox_inches='tight')
plt.show()
print(f"✓ Saved: pattern_comparison_{MODEL_NAME}.png")

# ----------------------------------------------------------------------------
# VIZ 4: Top Journey Flow (Simple Horizontal)
# ----------------------------------------------------------------------------

def draw_journey_flow(patterns, title, filename, top_n=5):
    """Draw horizontal journey flow for top patterns"""
    
    fig, axes = plt.subplots(top_n, 1, figsize=(16, top_n * 2))
    if top_n == 1:
        axes = [axes]
    
    colors = plt.cm.Blues(np.linspace(0.3, 0.9, 10))
    
    for idx, pattern in enumerate(patterns[:top_n]):
        ax = axes[idx]
        steps = pattern['pattern'].split(' → ')
        
        # Draw boxes for each step
        for i, step in enumerate(steps[:15]):  # Max 15 steps shown
            rect = plt.Rectangle((i * 1.1, 0.2), 1, 0.6, 
                                   facecolor=colors[i % len(colors)], 
                                   edgecolor='black', linewidth=1)
            ax.add_patch(rect)
            ax.text(i * 1.1 + 0.5, 0.5, step[:12], ha='center', va='center', 
                    fontsize=7, fontweight='bold')
            
            # Arrow to next
            if i < len(steps) - 1 and i < 14:
                ax.annotate('', xy=(i * 1.1 + 1.1, 0.5), xytext=(i * 1.1 + 1, 0.5),
                           arrowprops=dict(arrowstyle='->', color='gray'))
        
        if len(steps) > 15:
            ax.text(15 * 1.1 + 0.5, 0.5, f'... +{len(steps)-15} more', 
                    fontsize=8, style='italic')
        
        ax.set_xlim(-0.2, 17)
        ax.set_ylim(0, 1)
        ax.set_title(f"#{idx+1}: {pattern['users']} users | {pattern['avg_time']} min | {len(steps)} steps", 
                     fontsize=10, loc='left')
        ax.axis('off')
    
    plt.suptitle(title, fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(f'{DATA_DIR}{filename}', dpi=150, bbox_inches='tight')
    plt.show()
    print(f"✓ Saved: {filename}")

draw_journey_flow(pos_patterns, 'TOP SUCCESSFUL JOURNEY FLOWS', f'flow_success_{MODEL_NAME}.png', top_n=5)
draw_journey_flow(neg_patterns, 'TOP FAILED JOURNEY FLOWS', f'flow_failed_{MODEL_NAME}.png', top_n=5)

print(f"""
✓ PrefixSpan Visualizations Complete:
├── journey_patterns_{MODEL_NAME}.png (side-by-side comparison)
├── pattern_scatter_{MODEL_NAME}.png (length vs time)
├── pattern_comparison_{MODEL_NAME}.png (metrics comparison)
├── flow_success_{MODEL_NAME}.png (top 5 successful flows)
└── flow_failed_{MODEL_NAME}.png (top 5 failed flows)
""")
